{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 24, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/prabe/Desktop/credit_card_fraud_detection/pages/api/predict.ts"],"sourcesContent":["// pages/api/predict.ts\r\nimport type { NextApiRequest, NextApiResponse } from \"next\";\r\nimport { spawnSync } from \"child_process\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\n\r\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY || \"\";\r\n\r\nif (!GEMINI_API_KEY) {\r\n  console.warn(\"GEMINI_API_KEY is not configured\");\r\n}\r\n\r\nconst genAI = new GoogleGenerativeAI(GEMINI_API_KEY);\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  if (req.method !== \"POST\") return res.status(405).end();\r\n\r\n  const { features } = req.body;\r\n  console.log(\"API Received Features:\", features);\r\n\r\n  try {\r\n    // -------------------\r\n    // Call Python ML model\r\n    // -------------------\r\n    const py = spawnSync(\r\n      \"python\",\r\n      [\"models/predict.py\", JSON.stringify(features)],\r\n      { encoding: \"utf-8\" }\r\n    );\r\n\r\n    console.log(\"Python stdout:\", py.stdout);\r\n    console.log(\"Python stderr:\", py.stderr);\r\n\r\n    const pyResult = JSON.parse(py.stdout || '{\"error\":\"Python error\"}');\r\n\r\n    if (pyResult.error) {\r\n      return res.status(500).json({ error: pyResult.error });\r\n    }\r\n\r\n    // -------------------\r\n    // Call Gemini API for reasoning using SDK\r\n    // -------------------\r\n    if (!GEMINI_API_KEY) {\r\n      return res.status(200).json({\r\n        prediction: pyResult.prediction,\r\n        reasoning: \"Gemini API key is not configured\"\r\n      });\r\n    }\r\n\r\n    const predictionText = pyResult.prediction === 1 ? \"FRAUDULENT\" : \"LEGITIMATE\";\r\n    const prompt = `You are an expert fraud detection analyst. A machine learning model has classified this credit card transaction as ${predictionText}.\r\n\r\nTransaction Details:\r\n- Prediction: ${predictionText}\r\n- Features: ${features.join(\", \")}\r\n\r\nProvide a confident, detailed analysis (3-4 sentences) explaining:\r\n1. WHY this transaction is classified as ${predictionText.toLowerCase()}\r\n2. What specific patterns or indicators support this classification\r\n3. Key risk factors or safety indicators present in the data\r\n\r\nBe direct and authoritative in your explanation. Use phrases like \"This transaction is clearly...\" or \"The data strongly indicates...\" Avoid hedging language.`;\r\n\r\n    // Get the generative model\r\n    const model = genAI.getGenerativeModel({\r\n      model: \"gemini-2.0-flash-exp\",\r\n    });\r\n\r\n    // Generate content\r\n    const result = await model.generateContent({\r\n      contents: [{ role: \"user\", parts: [{ text: prompt }] }],\r\n    });\r\n\r\n    const response = await result.response;\r\n    const reasoning = response.text();\r\n\r\n    // -----------------------------\r\n    // Send response\r\n    // -----------------------------\r\n    res.status(200).json({\r\n      prediction: pyResult.prediction,\r\n      reasoning\r\n    });\r\n\r\n  } catch (err: any) {\r\n    console.error(\"API error:\", err);\r\n    res.status(500).json({ error: err.message || String(err) });\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,uBAAuB;;;;;AAEvB;AACA;;;;;;;AAEA,MAAM,iBAAiB,QAAQ,GAAG,CAAC,cAAc,IAAI;AAErD,IAAI,CAAC,gBAAgB;IACnB,QAAQ,IAAI,CAAC;AACf;AAEA,MAAM,QAAQ,IAAI,iPAAkB,CAAC;AAEtB,eAAe,QAAQ,GAAmB,EAAE,GAAoB;IAC7E,IAAI,IAAI,MAAM,KAAK,QAAQ,OAAO,IAAI,MAAM,CAAC,KAAK,GAAG;IAErD,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,IAAI;IAC7B,QAAQ,GAAG,CAAC,0BAA0B;IAEtC,IAAI;QACF,sBAAsB;QACtB,uBAAuB;QACvB,sBAAsB;QACtB,MAAM,KAAK,IAAA,gIAAS,EAClB,UACA;YAAC;YAAqB,KAAK,SAAS,CAAC;SAAU,EAC/C;YAAE,UAAU;QAAQ;QAGtB,QAAQ,GAAG,CAAC,kBAAkB,GAAG,MAAM;QACvC,QAAQ,GAAG,CAAC,kBAAkB,GAAG,MAAM;QAEvC,MAAM,WAAW,KAAK,KAAK,CAAC,GAAG,MAAM,IAAI;QAEzC,IAAI,SAAS,KAAK,EAAE;YAClB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO,SAAS,KAAK;YAAC;QACtD;QAEA,sBAAsB;QACtB,0CAA0C;QAC1C,sBAAsB;QACtB,IAAI,CAAC,gBAAgB;YACnB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAC1B,YAAY,SAAS,UAAU;gBAC/B,WAAW;YACb;QACF;QAEA,MAAM,iBAAiB,SAAS,UAAU,KAAK,IAAI,eAAe;QAClE,MAAM,SAAS,CAAC,mHAAmH,EAAE,eAAe;;;cAG1I,EAAE,eAAe;YACnB,EAAE,SAAS,IAAI,CAAC,MAAM;;;yCAGO,EAAE,eAAe,WAAW,GAAG;;;;8JAIsF,CAAC;QAE3J,2BAA2B;QAC3B,MAAM,QAAQ,MAAM,kBAAkB,CAAC;YACrC,OAAO;QACT;QAEA,mBAAmB;QACnB,MAAM,SAAS,MAAM,MAAM,eAAe,CAAC;YACzC,UAAU;gBAAC;oBAAE,MAAM;oBAAQ,OAAO;wBAAC;4BAAE,MAAM;wBAAO;qBAAE;gBAAC;aAAE;QACzD;QAEA,MAAM,WAAW,MAAM,OAAO,QAAQ;QACtC,MAAM,YAAY,SAAS,IAAI;QAE/B,gCAAgC;QAChC,gBAAgB;QAChB,gCAAgC;QAChC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YACnB,YAAY,SAAS,UAAU;YAC/B;QACF;IAEF,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,cAAc;QAC5B,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO,IAAI,OAAO;QAAK;IAC3D;AACF"}}]
}